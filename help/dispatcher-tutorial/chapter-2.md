---
title: “第2章 — 调度程序基础架构”
description: 了解发布和调度程序拓扑。 了解最常见的拓扑和设置。
feature: Dispatcher
topic: 架构
role: Architect
level: Beginner
source-git-commit: d9714b9a291ec3ee5f3dba9723de72bb120d2149
workflow-type: tm+mt
source-wordcount: '1866'
ht-degree: 0%

---


# 第2章 — 基础设施

## 设置缓存基础结构

在本系列第1章中，我们介绍了发布系统和调度程序的基本拓扑。 一组发布服务器和调度程序服务器可以配置为许多变体，具体取决于预期负载、数据中心的拓扑和所需的故障切换属性。

我们将描绘最常见的拓扑，并描述其优势和不足之处。 当然，这份清单永远不可能是全面的。 唯一的限制是你的想象力。

### “旧版”设置

在早期，潜在访客数量很少，硬件价格昂贵，Web服务器不像现在这样被视为业务关键型服务器。 常见的设置是在两个或多个发布系统之前让一个Dispatcher充当负载平衡器和缓存。 位于Dispatcher核心的Apache服务器非常稳定，并且在大多数设置中，能够提供足够数量的请求。

![“旧版”调度程序设置 — 按照当今的标准，不太常见](assets/chapter-2/legacy-dispatcher-setup.png)

*“旧版”调度程序设置 — 按照当今的标准，不太常见*

<br> 

调度程序从以下位置收到其名称：它基本上是在发送请求。 此设置已不再常见，因为它无法满足当今要求的更高性能和稳定性要求。

### 多腿设置

现在，稍有不同的拓扑更为常见。 多腿拓扑在每个发布服务器上将有一个Dispatcher。 专用（硬件）负载平衡器位于AEM基础架构的前面，用于向这两个（或更多）腿调度请求：

![现代“标准”调度程序设置 — 易于处理和维护](assets/chapter-2/modern-standard-dispatcher-setup.png)

*现代“标准”调度程序设置 — 易于处理和维护*

<br> 

这种安排的原因如下，

1. 网站平均提供的流量比过去多得多。 因此，需要扩展“Apache基础架构”。

2. “旧版”设置在调度程序级别上不提供冗余。 如果Apache Server发生故障，则整个网站不可访问。

3. Apache服务器很便宜。 它们基于开源，并且，如果您有虚拟数据中心，则可以非常快速地进行配置。

4. 此设置为“滚动”或“交错”更新方案提供了一种简单的方法。 在发布1上安装新软件包时，您只需关闭Dispatcher 1。 安装完成，并且您已从内部网络对Publish 1进行了充分的烟雾测试后，您可以清理Dispatcher 1上的缓存并重新启动它，同时关闭Dispatcher 2以维护Publish 2。

5. 在此设置中，缓存失效变得非常简单且具有确定性。 由于只有一个发布系统连接到一个Dispatcher，因此只有一个Dispatcher要失效。 失效的顺序和时间很琐碎。

### “扩展”设置

Apache Server便宜且易于配置，为何不进一步扩展该级别。 为什么每个发布服务器前面没有两个或多个Dispatcher?

![“扩展”设置 — 具有一些应用程序区域，但也有限制和注意事项](assets/chapter-2/scale-out-setup.png)

*“扩展”设置 — 具有一些应用程序区域，但也有限制和注意事项*

<br> 

你绝对能做到！ 并且该设置有许多有效的应用程序方案。 但是，您也应该考虑一些限制和复杂性。

#### 失效

每个发布系统都与多个Dispatcher连接，每个系统在内容发生更改时必须失效。

#### 维护

不言而喻，调度程序和发布系统的初始配置要复杂一些。 但同时也要记住，“滚动”版本的工作量也要高一些。 AEM系统可以且必须在运行时进行更新。 但明智的是，在主动提供请求的同时，不要这样做。 通常，您只想更新发布系统的一部分，而其他系统仍主动提供流量，然后在测试后，切换到另一部分。 如果您幸运，并且可以在部署过程中访问负载平衡器，则可以在此处禁用维护下到服务器的路由。 如果您使用的是共享负载平衡器，但没有直接访问权限，则宁可关闭要更新的发布的调度程序。 越多，你就越需要关门。 如果数量较大，并且您计划频繁更新，建议您执行一些自动化操作。 如果您没有自动化工具，那么扩大规模是坏主意。

在过去的项目中，我们使用了不同的技巧，从负载平衡中删除了发布系统，而无需直接访问负载平衡器本身。

负载平衡器通常为“ping”，这是一个特定页面，用于查看服务器是否已启动且正在运行。 通常情况下，Ping主页是一个琐碎的选择。 但是，如果要使用ping信号指示负载平衡器不平衡流量，则需要选择其他选项。 您可以创建专用模板或Servlet，以将其配置为使用`"up"`或`"down"`（在主体中或作为http响应代码）做出响应。 当然，该页面的响应不得缓存在调度程序中 — 因此始终从发布系统中新获取该页面。 现在，如果配置负载平衡器以检查此模板或Servlet，则可以轻松让Publish“假设”它关闭。 它不属于负载平衡的一部分，可以更新。

#### 全球分发

“全球分发”是一种“横向扩展”设置，在此设置中，您在每个发布系统前面都有多个Dispatcher — 现在分布在世界各地，以便更贴近客户并提供更好的性能。 当然，在这种情况下，您没有中央负载平衡器，而是拥有基于DNS和地理IP的负载平衡方案。

>[!NOTE]
>
>实际上，您正在使用此方法构建某种内容分发网络(CDN) — 因此您应考虑购买现成的CDN解决方案，而不是自己构建一个解决方案。 构建和维护自定义CDN并非一项琐碎的任务。

#### 水平缩放

即使在本地数据中心中，“扩展”拓扑也具有一些优势，其中每个发布系统前面有多个Dispatcher。 如果您发现Apache服务器因高流量（以及良好的缓存命中率）而出现性能瓶颈，并且无法再扩展硬件（通过添加CPU、RAM和更快的磁盘），则可以通过添加Dispatcher来提高性能。 这称为“水平缩放”。 但是，这是有限的，特别是当您经常使流量失效时。 我们将在下一节中描述此效果。

#### 扩展拓扑的限制

添加代理服务器通常应会提高性能。 但是，在某些情况下，添加服务器实际上会降低性能。 怎么？ 假设您有一个新闻门户，每分钟都会在该门户介绍新文章和页面。 Dispatcher通过“自动失效”使其失效：每当发布页面时，同一站点上缓存中的所有页面都会失效。 这是一项有用的功能 — 我们在此系列的[第1章](chapter-1.md)中介绍了此功能 — 但也意味着，如果您的网站经常发生更改，则会很频繁地使缓存失效。 如果每个发布实例只有一个Dispatcher，则请求页面的第一个访客将触发该页面的重新缓存。 第二位访客已获取缓存版本。

如果您有两个Dispatcher，则第二个访客有50%的机会未缓存页面，然后在再次呈现该页面时，他会遇到更大的延迟。 每次发布拥有更多Dispatcher会让情况更糟。 结果是，发布服务器会收到更多负载，因为它必须单独重新呈现每个Dispatcher的页面。

![在频繁缓存刷新的扩展场景中，性能下降。](assets/chapter-2/decreased-performance.png)

*在频繁缓存刷新的扩展场景中，性能下降。*

<br> 

#### 缓解过度扩展问题

您可以考虑为所有Dispatcher使用中央共享存储，或同步Apache服务器的文件系统以缓解问题。 我们只能提供有限的第一手体验，但必须做好准备，这会增加系统的复杂性，并会引入全新的错误类别。

我们在NFS上进行了一些实验，但NFS由于内容锁定而导致了巨大的性能问题。 这实际上降低了整体性能。

**结论**  — 建议不要在多个调度程序之间共享通用文件系统。

如果您遇到性能问题，请平等地扩展Publish和Dispatcher以避免Publisher实例出现峰值负载。 发布/调度程序比率没有黄金规则 — 它高度取决于请求的分发以及发布和缓存无效的频率。

如果您还担心访客体验的滞后，请考虑使用内容交付网络、缓存重取、抢先加热缓存，设置此系列[第1章](chapter-1.md)中所述的宽限时间，或参考[第3部分](chapter-3.md)的一些高级构思。

### “交叉连接”设置

我们每时每刻都看到的另一个设置是“跨连接”设置：发布实例没有专用的Dispatcher，但所有Dispatcher都连接到所有发布系统。

![交叉连接的拓扑：增加冗余和更复杂](assets/chapter-2/cross-connected-setup.png)

<br> 

*交叉连接的拓扑：增加冗余和更复杂。*

乍一看，这为相对较小的预算提供了一些更多冗余。 当其中一个Apache服务器关闭时，您仍然可以有两个发布系统来执行渲染工作。 此外，如果其中一个发布系统崩溃，您仍有两个Dispatcher来提供缓存的负载。

但这是有代价的。

首先，取一条腿进行维修是相当麻烦的。 事实上，这正是这个计划的目的；更有弹性，并尽可能保持运行。 我们看到了关于如何处理这些问题的复杂维护计划。 首先重新配置Dispatcher 2，删除交叉连接。 重新启动Dispatcher 2. 正在关闭Dispatcher 1、更新Publish 1、...等。 如果它长到两条以上，您应当仔细考虑。 你会得出这样的结论：它实际上增加了复杂性，增加了成本，并且是人类错误的可怕来源。 最好是自动化。 因此，最好检查一下，如果您确实有人力资源来将此自动化任务纳入您的项目计划。 虽然您可以通过此方式节省一些硬件成本，但您可能会在IT员工上花费两倍。

其次，您可能在AEM上运行了一些需要登录的用户应用程序。 您可以使用置顶会话，以确保始终从同一AEM实例中提供一个用户，以便能够维护该实例上的会话状态。 通过此跨连接设置，您必须确保在负载平衡器和Dispatcher上的粘性会话正常工作。 并非不可能，但您需要了解这一点，并添加一些额外的配置和测试时间，这可能会增加您通过保存硬件而计划的节省。

### 结论

我们不建议您将此跨连接方案用作默认选项。 但是，如果您决定使用它，则需要仔细评估风险和隐藏成本，并计划将配置自动化作为项目的一部分。

## 下一步

* [3 — 高级缓存主题](chapter-3.md)
